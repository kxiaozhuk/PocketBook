<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width,initial-scale=0.5, maximum-scale=0.5, minimum-scale=0.5, user-scalable=no">
    <!-- <meta name="x5-fullscreen" content="true"> -->
    <!-- <meta name="full-screen" content="yes"> -->

    <title>Pocket Book</title>
    <link rel="stylesheet" href="lib/bootstrap-4.0.0-dist/css/bootstrap.min.css">
    <style>
        .name {
            text-align: center;
            font-size: 66px;
            text-shadow: 3px 5px grey, 1px 1px #333;
        }

    </style>
</head>

<body>
    <div class="logo">
        <div class="name">POCKET BOOK</div>
    </div>
    <div class="container" align="center">
        <div class="row">
            <div class="col-lg-2" style="background-color: #34495e;height: 550px">
                <div class="home">
                    <h6 style="color: #fff;text-align: left;padding-top: 10px">选择账本</h6>
                </div>
                <div class="nav">
                    <select id="type" name="type" class="form-control">
                        <option value="default">默认账本</option>
                    </select>
                </div>
            </div>
            <div class="col-lg-10">
                <div class="breadcrumb">
<!--                   <p>
                    <a href="#"><b>Home > </b></a>
                    <a href="#"><b>账本1</b></a>
                  </p> -->
                </div>
                <div class="row btns">
                    <div class="col-md-2">
                        <button id="add" type="button" class="btn btn-block btn-md btn-primary addBtn" data-toggle="modal" data-target="#billAdd">新建</button>
                    </div>
                    <div class="del col-md-2 hidden">
                        <a href="javascript:;" class="btn btn-block btn-md btn-danger delBtn">删除</a>
                    </div>
                </div>
                <div class="panel panel-default">
                  <div class="panel-heading">账单列表
                    <input type="text" class="input-md col-xs-3 pull-right" id="filter" placeholder="Search in table">
                  </div>
                  <table class="footable table" data-page-size="10" data-filter=#filter>
                    <thead>
                    <tr>
                      <th>#</th>
                      <th>ID</th>
                      <th>收支类型</th>
                      <th>账单金额</th>
                      <th>作者</th>
                      <th>创建时间</th>
                    </tr>
                    </thead>
                    <tbody>
                    
                    </tbody>
                  </table>
                </div>

            </div>
        </div>
        <div class="text-center">
            <strong>Copyright</strong> 基于星云区块链的记账本&copy; 2017-2018
        </div>
    </div>
    <div class="modal fade" id="billAdd" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true" data-backdrop="false">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <div>添加账单</div>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newForm" class="form-horizontal" autocomplete="off">
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">收支类型</label>
                            <div class="col-sm-8">
                                <select id="type" name="type" class="form-control">
                                    <option value="I">收入</option>
                                    <option value="O">支出</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">金额</label>
                            <div class="col-sm-8">
                                <input id="amount" type="number" name="amount" class="form-control required"/>
                            </div>
                        </div>
                        <div class="form-group row">
                            <label class="col-sm-3 col-form-label">备注</label>
                            <div class="col-sm-8">
                                <textarea id="remarks" type="text" name="remarks" class="form-control"></textarea>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-dismiss="modal">取消</button>
                    <button id="addBtn" type="button" class="btn btn-default">创建</button>
                </div>
            </div>
        </div>
    </div>
<script src=lib/jquery-3.3.1.min.js></script>
<script src=lib/nebPay.js></script>
<script src=lib/bootstrap-4.0.0-dist/js/bootstrap.min.js></script>
<script src=lib/nebulas.js></script>
<script src=lib/footable.all.min.js></script>
<script>

    "use strict";

    var dappAddress = "n1UpSJ3r2m1ea6n5UhvbCeRmP215rN71xMD";

    var nebulas = require("nebulas"),
        Account = nebulas.Account,
        neb = new nebulas.Neb();
    neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));

    $(".addBtn").on("click", function() {
        var dialog = $("#billAdd");
        dialog.modal('show');
    });

    // 搜索功能: 查找Super-Dictionary 中有没有该词条
    $("#search").click(function(){
        // $("#search_value").val() 搜索框内的值

        var from = Account.NewAccount().getAddressString();

        var value = "0";
        var nonce = "0"
        var gas_price = "1000000"
        var gas_limit = "2000000"
        var callFunction = "get";
        var callArgs = "[\"" + $("#search_value").val() + "\"]"; //in the form of ["args"]
        var contract = {
            "function": callFunction,
            "args": callArgs
        }

        neb.api.call(from,dappAddress,value,nonce,gas_price,gas_limit,contract).then(function (resp) {
            cbSearch(resp)
        }).catch(function (err) {
            //cbSearch(err)
            console.log("error:" + err.message)
        })

    })

    //return of search,
    function cbSearch(resp) {
        var result = resp.result    ////resp is an object, resp.result is a JSON string
        console.log("return of rpc call: " + JSON.stringify(result))

        if (result === 'null'){
            $(".add_banner").addClass("hide");
            $(".result_success").addClass("hide");

            $("#result_faile_add").text($("#search_value").val())

            $(".result_faile").removeClass("hide");
        } else{
            //if result is not null, then it should be "return value" or "error message"
            try{
                result = JSON.parse(result)
            }catch (err){
                //result is the error message
            }

            if (!!result.key){      //"return value"
                $(".add_banner").addClass("hide");
                $(".result_faile").addClass("hide");

                $("#search_banner").text($("#search_value").val())
                $("#search_result").text(result.value)
                $("#search_result_author").text(result.author)

                $(".result_success").removeClass("hide");
            } else {        //"error message"
                $(".add_banner").addClass("hide");
                $(".result_faile").addClass("hide");

                $("#search_banner").text($("#search_value").val())
                $("#search_result").text(result)
                $("#search_result_author").text("")

                $(".result_success").removeClass("hide");
            }

        }

    }

    // 添加信息功能: 像super-dictionary 中添加词条
    $("#add").click(function() {
        $(".result_faile").addClass("hide");
        $(".add_banner").removeClass("hide");

        $("#add_value").val("")
    })

    var NebPay = require("nebpay");     //https://github.com/nebulasio/nebPay
    var nebPay = new NebPay();
    var serialNumber

    $("#push").click(function() {

        var to = dappAddress;
        var value = "0";
        var callFunction = "save"
        var callArgs = "[\"" + $("#search_value").val() + "\",\"" + $("#add_value").val() + "\"]"

        serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
            listener: cbPush        //设置listener, 处理交易返回信息
        });

        intervalQuery = setInterval(function () {
            funcIntervalQuery();
        }, 5000);
    });

    var intervalQuery

    function funcIntervalQuery() {
        nebPay.queryPayInfo(serialNumber)   //search transaction result from server (result upload to server by app)
            .then(function (resp) {
                console.log("tx result: " + resp)   //resp is a JSON string
                var respObject = JSON.parse(resp)
                if(respObject.code === 0){
                    alert(`set ${$("#search_value").val()} succeed!`)
                    clearInterval(intervalQuery)
                }
            })
            .catch(function (err) {
                console.log(err);
            });
    }

    function cbPush(resp) {
        console.log("response of push: " + JSON.stringify(resp))
    }
    $('.footable').footable();
</script>
</body>

</html>
